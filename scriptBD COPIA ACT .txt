CREATE DATABASE PWII;
USE PWII;

CREATE TABLE Usuario (
    id INT NOT NULL AUTO_INCREMENT,
    nombre_completo VARCHAR(100) NOT NULL,
    nombre_usuario VARCHAR(50) NOT NULL UNIQUE,
    contrasena VARCHAR(255) NOT NULL,
    correo VARCHAR(100) NOT NULL UNIQUE,
    fotografia BLOB, 
    baja BOOLEAN DEFAULT 0,
    PRIMARY KEY (id)
);

CREATE TABLE Publicacion (
    id INT NOT NULL AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    titulo VARCHAR(150) NOT NULL,
    descripcion VARCHAR(255),
    texto TEXT NOT NULL,
    baja BOOLEAN DEFAULT 0,
    PRIMARY KEY (id),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id)
);

CREATE TABLE Me_gusta (
    id_usuario INT NOT NULL,
    id_publicacion INT NOT NULL,
    PRIMARY KEY (id_usuario, id_publicacion),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id),
    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id)
);

CREATE TABLE Comentario (
    id INT NOT NULL AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    id_publicacion INT NOT NULL,
    comentario VARCHAR(500) NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id),
    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id)
);

CREATE TABLE Favorito (
    id INT NOT NULL AUTO_INCREMENT,
    id_usuario INT NOT NULL,
    id_publicacion INT NOT NULL,
    descripcion VARCHAR(255),
    PRIMARY KEY (id),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id),
    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id)
);

CREATE TABLE Seguir (
    id_usuarioA INT NOT NULL, 
    id_usuarioB INT NOT NULL, 
    PRIMARY KEY (id_usuarioA, id_usuarioB),
    FOREIGN KEY (id_usuarioA) REFERENCES Usuario(id),
    FOREIGN KEY (id_usuarioB) REFERENCES Usuario(id)
);


-- DROP DATABASE IF EXISTS PWII;
-- CREATE DATABASE PWII;
-- USE PWII;


DELIMITER //
CREATE PROCEDURE SP_RegistrarUsuario (
    IN p_nombre_completo VARCHAR(100),
    IN p_nombre_usuario VARCHAR(50),
    IN p_contrasena VARCHAR(255),
    IN p_correo VARCHAR(100),
    IN p_fotografia MEDIUMBLOB
)
BEGIN
    DECLARE v_usuario_existente_nombre INT DEFAULT 0;
    DECLARE v_usuario_existente_correo INT DEFAULT 0;
    
    IF LENGTH(p_nombre_completo) > 99 THEN
        SELECT NULL AS id_registro, 'ERROR: El nombre completo no debe superar los 99 caracteres.' AS mensaje_estado;
    
    ELSEIF LENGTH(p_correo) > 99 THEN
        SELECT NULL AS id_registro, 'ERROR: El correo no debe superar los 99 caracteres.' AS mensaje_estado;
        
    ELSEIF LENGTH(p_nombre_usuario) > 49 OR p_nombre_usuario LIKE '% %' THEN
        SELECT NULL AS id_registro, 'ERROR: El nombre de usuario no es válido (máx 49 chars y sin espacios).' AS mensaje_estado;
        
    ELSEIF LENGTH(p_contrasena) < 8 OR LENGTH(p_contrasena) > 16 OR p_contrasena LIKE '% %' THEN
        SELECT NULL AS id_registro, 'ERROR: La contraseña debe tener entre 8 y 16 caracteres y no contener espacios.' AS mensaje_estado;

    ELSE
        SELECT COUNT(id) INTO v_usuario_existente_nombre
        FROM Usuario
        WHERE nombre_usuario = p_nombre_usuario;

        SELECT COUNT(id) INTO v_usuario_existente_correo
        FROM Usuario
        WHERE correo = p_correo;

        IF v_usuario_existente_nombre > 0 THEN
            SELECT NULL AS id_registro, 'ERROR: Nombre de usuario ya registrado' AS mensaje_estado;

        ELSEIF v_usuario_existente_correo > 0 THEN
            SELECT NULL AS id_registro, 'ERROR: Correo ya registrado' AS mensaje_estado;

        ELSE
            INSERT INTO Usuario (
                nombre_completo,
                nombre_usuario,
                contrasena,
                correo,
                fotografia
            )
            VALUES (
                p_nombre_completo,
                p_nombre_usuario,
                p_contrasena,
                p_correo,
                p_fotografia
            );

            SELECT LAST_INSERT_ID() AS id_registro, 'REGISTRO EXITOSO' AS mensaje_estado;

        END IF;

    END IF;

END //
DELIMITER ;


DELIMITER //
CREATE PROCEDURE SP_IniciarSesion (
    IN p_nombre_usuario VARCHAR(50),
    IN p_contrasena VARCHAR(255)
)
BEGIN
    DECLARE v_id INT;
    DECLARE v_contrasena_db VARCHAR(255);
    DECLARE v_baja_db BOOLEAN;

    SELECT id, contrasena, baja
    INTO v_id, v_contrasena_db, v_baja_db
    FROM Usuario
    WHERE nombre_usuario = p_nombre_usuario;

    IF v_id IS NULL THEN
        SELECT NULL AS id, 'USUARIO_NO_ENCONTRADO' AS estado_sesion;
        
    ELSEIF v_contrasena_db != p_contrasena THEN
        SELECT NULL AS id, 'CONTRASENA_INCORRECTA' AS estado_sesion;
        
    ELSEIF v_baja_db = 1 THEN
        SELECT NULL AS id, 'DADO_BAJA' AS estado_sesion;
        
    ELSE
        SELECT v_id AS id, 'LOGIN_EXITOSO' AS estado_sesion;
        
    END IF;

END //
DELIMITER ;


DELIMITER //
CREATE PROCEDURE SP_ObtenerDatosDePerfil (
    IN p_id INT
)
BEGIN
    SELECT
        U.nombre_completo,
        U.nombre_usuario,
        U.correo,
        U.fotografia,
        CASE 
            WHEN U.baja = 0 THEN 'ACTIVO'
            WHEN U.baja = 1 THEN 'DADO_BAJA'
            ELSE 'NO_ENCONTRADO'
        END AS estado_perfil
    FROM
        Usuario U
    WHERE
        U.id = p_id;

END //
DELIMITER ;


CAMBIOS AL SCRITP 

-- =========================================
-- ALTER TABLE para fechas
-- =========================================
ALTER TABLE Usuario
ADD fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
ADD fecha_actualizacion DATETIME ON UPDATE CURRENT_TIMESTAMP;

ALTER TABLE Publicacion
ADD fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
ADD fecha_actualizacion DATETIME ON UPDATE CURRENT_TIMESTAMP;

ALTER TABLE Comentario
ADD fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP;


===opcional======================================
FOREIGN KEY (id_usuario) REFERENCES Usuario(id) ON DELETE CASCADE



-- =========================================
-- Procedimientos adicionales (se puede unificar pero creo que lo complicaria)
-- =========================================

DELIMITER //
CREATE PROCEDURE SP_EditarPerfil (
    IN p_id INT,
    IN p_nombre_completo VARCHAR(100),
    IN p_correo VARCHAR(100),
    IN p_fotografia BLOB
)
BEGIN
    UPDATE Usuario
    SET nombre_completo = p_nombre_completo,
        correo = p_correo,
        fotografia = p_fotografia
    WHERE id = p_id AND baja = 0;

    SELECT 'PERFIL_ACTUALIZADO' AS estado_edicion;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE SP_CrearPublicacion (
    IN p_id_usuario INT,
    IN p_titulo VARCHAR(150),
    IN p_descripcion VARCHAR(255),
    IN p_texto TEXT
)
BEGIN
    INSERT INTO Publicacion (
        id_usuario,
        titulo,
        descripcion,
        texto
    ) VALUES (
        p_id_usuario,
        p_titulo,
        p_descripcion,
        p_texto
    );

    SELECT LAST_INSERT_ID() AS id_publicacion, 'PUBLICACION_CREADA' AS estado;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE SP_ObtenerComentariosPorPublicacion (
    IN p_id_publicacion INT
)
BEGIN
    SELECT
        C.id,
        C.comentario,
        C.fecha_creacion,
        U.nombre_usuario
    FROM Comentario C
    JOIN Usuario U ON C.id_usuario = U.id
    WHERE C.id_publicacion = p_id_publicacion;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE SP_ObtenerRankingPublicaciones ()
BEGIN
    SELECT
        P.id,
        P.titulo,
        P.descripcion,
        COUNT(M.id_usuario) AS total_me_gusta
    FROM Publicacion P
    LEFT JOIN Me_gusta M ON P.id = M.id_publicacion
    WHERE P.baja = 0
    GROUP BY P.id
    ORDER BY total_me_gusta DESC
    LIMIT 10;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE SP_ObtenerFeed (
    IN p_id_usuario INT
)
BEGIN
    SELECT
        P.id,
        P.titulo,
        P.descripcion,
        P.fecha_creacion,
        U.nombre_usuario
    FROM Publicacion P
    JOIN Usuario U ON P.id_usuario = U.id
    WHERE P.id_usuario IN (
        SELECT id_usuarioB FROM Seguir WHERE id_usuarioA = p_id_usuario
    )
    AND P.baja = 0
    ORDER BY P.fecha_creacion DESC;
END //
DELIMITER ;

